<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Top Level Namespace
  
    &mdash; StoryTime Docs
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!top-level-namespace.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index</a> &raquo;
    
    
    <span class="title">Top Level Namespace</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Top Level Namespace
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
      <dt class="r1">Includes:</dt>
      <dd class="r1"><span class='object_link'><a href="ExperimentConstants.html" title="ExperimentConstants (module)">ExperimentConstants</a></span>, Text</dd>
      
    
  
  
  
</dl>
<div class="clear"></div>

<h2>Defined Under Namespace</h2>
<p class="children">
  
    
      <strong class="modules">Modules:</strong> <span class='object_link'><a href="ExperimentConstants.html" title="ExperimentConstants (module)">ExperimentConstants</a></span>, <span class='object_link'><a href="RoutesHelper.html" title="RoutesHelper (module)">RoutesHelper</a></span>, <span class='object_link'><a href="SMSResponseHelper.html" title="SMSResponseHelper (module)">SMSResponseHelper</a></span>
    
  
    
      <strong class="classes">Classes:</strong> <span class='object_link'><a href="MainWorker.html" title="MainWorker (class)">MainWorker</a></span>, <span class='object_link'><a href="NewTextWorker.html" title="NewTextWorker (class)">NewTextWorker</a></span>, <span class='object_link'><a href="NextMessageWorker.html" title="NextMessageWorker (class)">NextMessageWorker</a></span>, <span class='object_link'><a href="Sprint.html" title="Sprint (class)">Sprint</a></span>, <span class='object_link'><a href="Story.html" title="Story (class)">Story</a></span>, <span class='object_link'><a href="StorySeries.html" title="StorySeries (class)">StorySeries</a></span>, <span class='object_link'><a href="TwilioHelper.html" title="TwilioHelper (class)">TwilioHelper</a></span>
    
  
</p>

  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="STAGGER_TIME-constant" class="">STAGGER_TIME =
          <div class="docstring">
  <div class="discussion">
    
<p>The seconds to wait between  signup texts to parents.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>10</span></pre></dd>
      
        <dt id="TIME_DST-constant" class="">TIME_DST =
          
        </dt>
        <dd><pre class="code"><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='lparen'>(</span><span class='int'>2015</span><span class='comma'>,</span> <span class='int'>6</span><span class='comma'>,</span> <span class='int'>21</span><span class='comma'>,</span> <span class='int'>21</span><span class='comma'>,</span> <span class='int'>30</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="TIME_NO_DST-constant" class="">TIME_NO_DST =
          <div class="docstring">
  <div class="discussion">
    
<p>21:30 UTC (17:30 EST â€“&gt; 5:30 PM on East Coast) -04:00</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='lparen'>(</span><span class='int'>2015</span><span class='comma'>,</span> <span class='int'>6</span><span class='comma'>,</span> <span class='int'>21</span><span class='comma'>,</span> <span class='int'>22</span><span class='comma'>,</span> <span class='int'>30</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span></pre></dd>
      
        <dt id="DEFAULT_TIME-constant" class="">DEFAULT_TIME =
          
        </dt>
        <dd><pre class="code"><span class='id identifier rubyid_default'>default</span></pre></dd>
      
        <dt id="SEC_IN_DAY-constant" class="">SEC_IN_DAY =
          
        </dt>
        <dd><pre class="code"><span class='float'>86400.0</span></pre></dd>
      
        <dt id="DAYS_FOR_EXPERIMENT-constant" class="">DAYS_FOR_EXPERIMENT =
          <div class="docstring">
  <div class="discussion">
    
<p>the number of days until report results</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>days_for_experiment</span><span class='tstring_end'>&quot;</span></span></pre></dd>
      
        <dt id="TO_24_HOUR_OFFSET-constant" class="">TO_24_HOUR_OFFSET =
          <div class="docstring">
  <div class="discussion">
    
<p>added to pm times to get 24-hour clock time</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='int'>12</span></pre></dd>
      
    </dl>
  



  
  
  <h3 class="inherited">Constants included
     from <span class='object_link'><a href="ExperimentConstants.html" title="ExperimentConstants (module)">ExperimentConstants</a></span></h3>
  <p class="inherited"><span class='object_link'><a href="ExperimentConstants.html#DAYS_TO_START_FLAG-constant" title="ExperimentConstants::DAYS_TO_START_FLAG (constant)">ExperimentConstants::DAYS_TO_START_FLAG</a></span>, <span class='object_link'><a href="ExperimentConstants.html#TIME_FLAG-constant" title="ExperimentConstants::TIME_FLAG (constant)">ExperimentConstants::TIME_FLAG</a></span>, <span class='object_link'><a href="ExperimentConstants.html#VALID_FLAGS-constant" title="ExperimentConstants::VALID_FLAGS (constant)">ExperimentConstants::VALID_FLAGS</a></span></p>





  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#app_enroll-instance_method" title="#app_enroll (instance method)">- (Object) <strong>app_enroll</strong>(params, user_phone, locale, type, *wait_time) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Enroll the user for stories, sending first story and text.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#app_enroll_many-instance_method" title="#app_enroll_many (instance method)">- (Object) <strong>app_enroll_many</strong>(phone_nums, locale, *params) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Wrapper for subscribing many users.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#check_reports-instance_method" title="#check_reports (instance method)">- (Object) <strong>check_reports</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if any experiments have finished.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#create_experiment-instance_method" title="#create_experiment (instance method)">- (Object) <strong>create_experiment</strong>(variable, options_arr, users, days, *notes) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Create an experiment, along with all it&#39;s associatied variations.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#form_success-instance_method" title="#form_success (instance method)">- (Object) <strong>form_success</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Create an experiment from the params selected on the experiment dashboard.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#get_new_wait-instance_method" title="#get_new_wait (instance method)">- (Object) <strong>get_new_wait</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return the next parent&#39;s wait time   for their first story: one STAGGER
after the last parent&#39;s time.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#is_dst%3F-instance_method" title="#is_dst? (instance method)">- (Boolean) <strong>is_dst?</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return whether it&#39;s daylight savings time in EST TODO fix hack based on
months.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#send_report-instance_method" title="#send_report (instance method)">- (Object) <strong>send_report</strong>(experiment_id) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Email report about results of the given experiment.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#series_choice_choose-instance_method" title="#series_choice_choose (instance method)">- (Object) <strong>series_choice_choose</strong>(user_id, note) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Invite the user to choose a series.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#series_choice_drop-instance_method" title="#series_choice_drop (instance method)">- (Object) <strong>series_choice_drop</strong>(user_id, note) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Drop the user and notify her.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#series_choice_remind-instance_method" title="#series_choice_remind (instance method)">- (Object) <strong>series_choice_remind</strong>(user_id, note) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Remind the user to choose a series.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#series_choice_reply-instance_method" title="#series_choice_reply (instance method)">- (Object) <strong>series_choice_reply</strong>(user_id, params) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Reply to a user&#39;s series choice.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="top-level-namespace.html#with_captured_stdout-instance_method" title="#with_captured_stdout (instance method)">- (Object) <strong>with_captured_stdout</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>capture stdout and return it as a string/ ensure clause restores $stdout.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  
  
  
  
  
  

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="app_enroll-instance_method">
  
    - (<tt>Object</tt>) <strong>app_enroll</strong>(params, user_phone, locale, type, *wait_time) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Enroll the user for stories, sending first story and text. Alternatively,
used to send a sample story.</p>

<pre class="code ruby"><code class="ruby">params =&gt; fake user data:
  [Carrier: &quot;ATT&quot;, Body: &quot;BREAK&quot;] etc. 
  -(For TEST mode. Normally given by Twilio.) 
user_phone =&gt; phone number: &quot;+15614449999&quot;
locale =&gt; language: &quot;en&quot;
type =&gt; sample or story: SAMPLE
wait_time) =&gt; async wait to send: [14]
  -(for manual signup)
</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/enroll.rb', line 112</span>

<span class='kw'>def</span> <span class='id identifier rubyid_app_enroll'>app_enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_user_phone'>user_phone</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='id identifier rubyid_type'>type</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_wait_time'>wait_time</span><span class='rparen'>)</span> 

  <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_phone'>find_by_phone</span><span class='lparen'>(</span><span class='id identifier rubyid_user_phone'>user_phone</span><span class='rparen'>)</span> <span class='comment'>#check if already registered.
</span>
  <span class='kw'>if</span> <span class='ivar'>@user</span> <span class='op'>==</span> <span class='kw'>nil</span>
    <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>phone:</span> <span class='id identifier rubyid_user_phone'>user_phone</span><span class='comma'>,</span> <span class='label'>locale:</span> <span class='id identifier rubyid_locale'>locale</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'>#PRO, set locale for returning user 
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_locale'>locale</span> <span class='op'>!=</span> <span class='kw'>nil</span> <span class='op'>&amp;&amp;</span> <span class='ivar'>@user</span> <span class='op'>!=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_i18n'>i18n</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_default_places'>default_places</span><span class='rparen'>)</span>
        <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_thread_set'>thread_set</span><span class='lparen'>(</span><span class='id identifier rubyid_i18n'>i18n</span><span class='rparen'>)</span>
    <span class='comment'>#set the locale for that user, w/in this thread
</span>  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>STORY</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>sample:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>true</span><span class='rparen'>)</span> 
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>locale:</span> <span class='id identifier rubyid_locale'>locale</span><span class='rparen'>)</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>SAMPLE</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>sample:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>STORY</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>days_per_week:</span> <span class='int'>2</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'>#must manually set default time.
</span>  <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>time:</span> <span class='const'>DEFAULT_TIME</span><span class='rparen'>)</span>


  <span class='comment'>## ASSIGN TO EXPERIMENT VARIATION
</span>  <span class='comment'>#  -get first experiment
</span>  <span class='comment'>#  -assign user to one of its variation
</span>  <span class='comment'>#  -alternate variations using modulo
</span>  <span class='comment'>#
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>STORY</span>    <span class='comment'>#grab first experiment with users left to assign
</span>    <span class='kw'>if</span> <span class='const'>Experiment</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>active = true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>!=</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span>
      <span class='lparen'>(</span><span class='id identifier rubyid_our_experiment'>our_experiment</span> <span class='op'>=</span> <span class='const'>Experiment</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>active = true AND users_to_assign != &#39;0&#39;</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='rparen'>)</span>

      <span class='id identifier rubyid_users_to_assign'>users_to_assign</span> <span class='op'>=</span> <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_users_to_assign'>users_to_assign</span>

      <span class='comment'>#get valid variations from first experiment
</span>      <span class='id identifier rubyid_variations'>variations</span> <span class='op'>=</span> <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span>

      <span class='comment'>#user-count used to alternate which variation chosen
</span>      <span class='comment'>#Eg. with three variations:
</span>      <span class='comment'># u1 -&gt; v1, u2 -&gt; v2 ... u4 -&gt; v1, u5 - &gt; v2
</span>      <span class='id identifier rubyid_var'>var</span> <span class='op'>=</span> <span class='id identifier rubyid_variations'>variations</span><span class='lbracket'>[</span><span class='id identifier rubyid_users_to_assign'>users_to_assign</span> <span class='op'>%</span> <span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='rbracket'>]</span>
      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_variation'>variation</span> <span class='op'>=</span> <span class='id identifier rubyid_var'>var</span> <span class='comment'>#give user the variation
</span>      <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='ivar'>@user</span> <span class='comment'>#give variation the user
</span>
      <span class='comment'>#save to DB (TODO: necessary?)
</span>      <span class='comment'>#update user with experiment variation
</span>

      <span class='kw'>case</span> <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_variable'>variable</span>
      <span class='kw'>when</span> <span class='const'>ExperimentConstants</span><span class='op'>::</span><span class='const'>TIME_FLAG</span>
         <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>time:</span> <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_date_option'>date_option</span><span class='rparen'>)</span>
      <span class='kw'>when</span> <span class='const'>ExperimentConstants</span><span class='op'>::</span><span class='const'>DAYS_TO_START_FLAG</span>
         <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>days_per_week:</span> <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='comment'>#update exp time by popping off REDIS last days set
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_end_date'>end_date</span> <span class='op'>==</span> <span class='kw'>nil</span> 
        <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>end_date:</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span> <span class='op'>+</span> 
                        <span class='const'>REDIS</span><span class='period'>
</span><span class='id identifier rubyid_                       .rpop'>                       .rpop</span><span class='lparen'>(</span><span class='const'>DAYS_FOR_EXPERIMENT</span><span class='rparen'>)</span><span class='period'>
</span><span class='id identifier rubyid_                       .to_i'>                       .to_i</span><span class='period'>
</span><span class='id identifier rubyid_                       .days'>                       .days</span><span class='rparen'>)</span>
      <span class='kw'>end</span>


      <span class='comment'>#one more user was assigned
</span>      <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>users_to_assign:</span> <span class='id identifier rubyid_users_to_assign'>users_to_assign</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span>
    
      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>
      <span class='id identifier rubyid_our_experiment'>our_experiment</span><span class='period'>.</span><span class='id identifier rubyid_save'>save</span>


    <span class='kw'>end</span>

  <span class='kw'>end</span>


  <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span>
      <span class='id identifier rubyid_account_sid'>account_sid</span> <span class='op'>=</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TW_ACCOUNT_SID</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
      <span class='id identifier rubyid_auth_token'>auth_token</span> <span class='op'>=</span> <span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>TW_AUTH_TOKEN</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span>
      <span class='ivar'>@client</span> <span class='op'>=</span> <span class='const'>Twilio</span><span class='op'>::</span><span class='const'>REST</span><span class='op'>::</span><span class='const'>LookupsClient</span><span class='period'>.</span>
            <span class='id identifier rubyid_new'>new</span> <span class='id identifier rubyid_account_sid'>account_sid</span><span class='comma'>,</span> <span class='id identifier rubyid_auth_token'>auth_token</span>
      <span class='comment'># Lookup wireless carrier if not already done in SAMPLE
</span>      <span class='kw'>if</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_carrier'>carrier</span> <span class='op'>==</span> <span class='kw'>nil</span>
        <span class='id identifier rubyid_number'>number</span> <span class='op'>=</span> <span class='ivar'>@client</span><span class='period'>.</span><span class='id identifier rubyid_phone_numbers'>phone_numbers</span><span class='period'>.</span>
              <span class='id identifier rubyid_get'>get</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span> <span class='label'>type:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>carrier</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
        <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>carrier:</span> <span class='id identifier rubyid_number'>number</span><span class='period'>.</span><span class='id identifier rubyid_carrier'>carrier</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>name</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>TEST</span>
      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>carrier:</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Carrier</span><span class='rbracket'>]</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_days'>days</span> <span class='op'>=</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

    <span class='kw'>if</span> <span class='id identifier rubyid_locale'>locale</span> <span class='op'>!=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_i18n'>i18n</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_default_places'>default_places</span><span class='rparen'>)</span>
        <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_thread_set'>thread_set</span><span class='lparen'>(</span><span class='id identifier rubyid_i18n'>i18n</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'>#NOT manually enrolled: respond to their signup text!
</span>  <span class='comment'>#NOTE! TODO This isn&#39;t configured for spanish, which require a two page Sprint response! 
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>STORY</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='kw'>nil</span>
        <span class='kw'>if</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_carrier'>carrier</span> <span class='op'>==</span> <span class='const'>Text</span><span class='op'>::</span><span class='const'>SPRINT</span>
          <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text_and_mms'>text_and_mms</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='period'>.</span><span class='id identifier rubyid_sprint'>sprint</span><span class='lparen'>(</span><span class='id identifier rubyid_days'>days</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span>
            <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text_and_mms'>text_and_mms</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='lparen'>(</span><span class='id identifier rubyid_days'>days</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span>
            <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
        <span class='comment'>#update total message count 
</span>        <span class='comment'>#NOTE: NextMessageWorker does it for auto-enrolled.
</span>        <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>total_messages:</span> <span class='int'>1</span><span class='rparen'>)</span>
    <span class='kw'>else</span> <span class='comment'>#SEND NEW text, not response.
</span>      <span class='id identifier rubyid_wait_time'>wait_time</span> <span class='op'>=</span> <span class='id identifier rubyid_wait_time'>wait_time</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
      <span class='kw'>if</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_carrier'>carrier</span> <span class='op'>==</span> <span class='const'>Text</span><span class='op'>::</span><span class='const'>SPRINT</span>        
          <span class='const'>NextMessageWorker</span><span class='period'>.</span><span class='id identifier rubyid_perform_in'>perform_in</span><span class='lparen'>(</span><span class='id identifier rubyid_wait_time'>wait_time</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='comma'>,</span>
                     <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='period'>.</span><span class='id identifier rubyid_sprint'>sprint</span><span class='lparen'>(</span><span class='id identifier rubyid_days'>days</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span> 
                  <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
        <span class='kw'>else</span>
          <span class='const'>NextMessageWorker</span><span class='period'>.</span><span class='id identifier rubyid_perform_in'>perform_in</span><span class='lparen'>(</span><span class='id identifier rubyid_wait_time'>wait_time</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='comma'>,</span>
                             <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='lparen'>(</span><span class='id identifier rubyid_days'>days</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span>
                <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
        <span class='kw'>end</span>
    <span class='kw'>end</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>SAMPLE</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_casecmp'>casecmp</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>0</span> 
        <span class='kw'>if</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_carrier'>carrier</span> <span class='op'>==</span> <span class='const'>Text</span><span class='op'>::</span><span class='const'>SPRINT</span>
        <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text_and_mms'>text_and_mms</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span><span class='period'>.</span><span class='id identifier rubyid_sprint'>sprint</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text_and_mms'>text_and_mms</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
    <span class='kw'>elsif</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_casecmp'>casecmp</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_example'>example</span><span class='rparen'>)</span> <span class='op'>==</span> <span class='int'>0</span> 
      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text_and_mms'>text_and_mms</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_example'>example</span><span class='comma'>,</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_first_mms'>first_mms</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span> 
    <span class='kw'>end</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="app_enroll_many-instance_method">
  
    - (<tt>Object</tt>) <strong>app_enroll_many</strong>(phone_nums, locale, *params) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Wrapper for subscribing many users.</p>

<pre class="code ruby"><code class="ruby">- Send the first &#39;signup&#39; story (MMS with into SMS).
- Take array of parent phone numbers, with given language.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/enroll.rb', line 78</span>

<span class='kw'>def</span> <span class='id identifier rubyid_app_enroll_many'>app_enroll_many</span><span class='lparen'>(</span><span class='id identifier rubyid_phone_nums'>phone_nums</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>
  <span class='ivar'>@wait</span> <span class='op'>=</span> <span class='int'>0</span> 

  <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>TEST</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_params'>params</span> <span class='op'>==</span> <span class='kw'>nil</span> 
      <span class='comment'># Set fake. 
</span>      <span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>Carrier:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ATT</span><span class='tstring_end'>&quot;</span></span><span class='rbrace'>}</span>
    <span class='kw'>else</span> 
      <span class='comment'># Pop from array.
</span>      <span class='id identifier rubyid_params'>params</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span>
    <span class='kw'>end</span> 
  <span class='kw'>end</span>

  <span class='id identifier rubyid_phone_nums'>phone_nums</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_phone'>phone</span><span class='op'>|</span>
    <span class='id identifier rubyid_app_enroll'>app_enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='const'>STORY</span><span class='comma'>,</span> <span class='id identifier rubyid_get_new_wait'>get_new_wait</span><span class='lparen'>(</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Enrolled </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_phone'>phone</span><span class='embexpr_end'>}</span><span class='tstring_content'>.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="check_reports-instance_method">
  
    - (<tt>Object</tt>) <strong>check_reports</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if any experiments have finished. If so, Send the report.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'experiment/report.rb', line 24</span>

<span class='kw'>def</span> <span class='id identifier rubyid_check_reports'>check_reports</span>
	<span class='kw'>begin</span>
	  <span class='comment'>#Experiment: Send report if completed--&gt;i.e. past end_date! 
</span>	  <span class='const'>Experiment</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>active = true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_exper'>exper</span><span class='op'>|</span>
	    <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_end_date'>end_date</span> <span class='op'>&amp;&amp;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_end_date'>end_date</span><span class='rparen'>)</span>
	      <span class='id identifier rubyid_send_report'>send_report</span><span class='lparen'>(</span><span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='rparen'>)</span>
	    <span class='kw'>end</span>
	  <span class='kw'>end</span>
	<span class='kw'>rescue</span> <span class='const'>StandardError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
	    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Experiment report not sent.\n\nError: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
	    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\nBacktrace:\n\n</span><span class='tstring_end'>&quot;</span></span>
	    <span class='lparen'>(</span><span class='int'>1</span><span class='op'>..</span><span class='int'>30</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span> <span class='rbrace'>}</span>
	<span class='kw'>end</span>    
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="create_experiment-instance_method">
  
    - (<tt>Object</tt>) <strong>create_experiment</strong>(variable, options_arr, users, days, *notes) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Create an experiment, along with all it&#39;s associatied variations.</p>

<p>variable    - the String of what to experiment on options_arr - the Array
of what values the variable should take.</p>

<pre class="code ruby"><code class="ruby">For time: [HH,MM] pairs. E.g. [06,30]
for 6:30PM EST (12-hour clock, assumes PM)</code></pre>

<p>users       - the Integer num of next users who will be enrolled</p>

<pre class="code ruby"><code class="ruby">in the experiment.</code></pre>

<p>days        - the Integer number of days experiment should wait</p>

<pre class="code ruby"><code class="ruby">until sending results.</code></pre>

<p>*notes      - the String of comments on experiment or hypothesis</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'experiment/create_experiment.rb', line 44</span>

<span class='kw'>def</span> <span class='id identifier rubyid_create_experiment'>create_experiment</span><span class='lparen'>(</span><span class='id identifier rubyid_variable'>variable</span><span class='comma'>,</span>
                      <span class='id identifier rubyid_options_arr'>options_arr</span><span class='comma'>,</span>
                      <span class='id identifier rubyid_users'>users</span><span class='comma'>,</span>
                      <span class='id identifier rubyid_days'>days</span><span class='comma'>,</span>
                      <span class='op'>*</span><span class='id identifier rubyid_notes'>notes</span><span class='rparen'>)</span>
    
  <span class='kw'>if</span> <span class='op'>!</span><span class='const'>ExperimentConstants</span><span class='op'>::</span><span class='const'>VALID_FLAGS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span> <span class='id identifier rubyid_variable'>variable</span>
    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Must experiment with a valid option.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>


  <span class='comment'>#check that Array isn&#39;t empty.
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Array</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
     <span class='lparen'>(</span><span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>options_arr must not be empty.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># store the number of days in a queue,
</span>  <span class='comment'># to set end_date for DAYS time ahead
</span>  <span class='comment'># when first enroll users
</span>  <span class='const'>REDIS</span><span class='period'>.</span><span class='id identifier rubyid_lpush'>lpush</span> <span class='const'>DAYS_FOR_EXPERIMENT</span><span class='comma'>,</span> <span class='id identifier rubyid_days'>days</span>


  <span class='id identifier rubyid_exper'>exper</span> <span class='op'>=</span> <span class='const'>Experiment</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>variable:</span> <span class='id identifier rubyid_variable'>variable</span><span class='comma'>,</span>
                            <span class='label'>users_to_assign:</span> <span class='id identifier rubyid_users'>users</span><span class='rparen'>)</span>
  <span class='comment'>#inlude notes, if given
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_notes'>notes</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_notes'>notes</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>!=</span> <span class='kw'>nil</span>
    <span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>notes:</span> <span class='id identifier rubyid_notes'>notes</span><span class='period'>.</span><span class='id identifier rubyid_pop'>pop</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Every option is a varation. 
</span>  <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_option'>option</span><span class='op'>|</span> 

    <span class='kw'>case</span> <span class='id identifier rubyid_variable'>variable</span> 

    <span class='kw'>when</span> <span class='const'>ExperimentConstants</span><span class='op'>::</span><span class='const'>TIME_FLAG</span>

      <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Fixnum</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
             <span class='lparen'>(</span><span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Fixnum</span><span class='rparen'>)</span> 

        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>[HH,MM] must a Fixnums.</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='kw'>unless</span> <span class='lparen'>(</span><span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>&lt;</span> <span class='int'>12</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>&gt;</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
             <span class='lparen'>(</span><span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span> <span class='op'>&lt;</span> <span class='int'>60</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>&gt;=</span> <span class='int'>0</span><span class='rparen'>)</span>
      
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Time must be between 1 and 11:59pm</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='kw'>unless</span> <span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='int'>2</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Must have 2 values in array.</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>


      <span class='kw'>if</span> <span class='id identifier rubyid_is_dst?'>is_dst?</span>
        <span class='id identifier rubyid_est_to_utc_offset'>est_to_utc_offset</span> <span class='op'>=</span> <span class='int'>4</span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_est_to_utc_offset'>est_to_utc_offset</span> <span class='op'>=</span> <span class='int'>5</span>
      <span class='kw'>end</span>

      <span class='comment'>#convert the time [5,30] to UTC by adding the offset
</span>      <span class='id identifier rubyid_t'>t</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='lparen'>(</span><span class='int'>2015</span><span class='comma'>,</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_month'>month</span><span class='comma'>,</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_day'>day</span><span class='comma'>,</span> <span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='op'>+</span>
                               <span class='id identifier rubyid_est_to_utc_offset'>est_to_utc_offset</span> <span class='op'>+</span> 
                               <span class='const'>TO_24_HOUR_OFFSET</span><span class='comma'>,</span> 
                               <span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_last'>last</span><span class='comma'>,</span> <span class='int'>0</span><span class='rparen'>)</span>
      
      <span class='id identifier rubyid_var'>var</span> <span class='op'>=</span> <span class='const'>Variation</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>date_option:</span> <span class='id identifier rubyid_t'>t</span><span class='comma'>,</span> <span class='label'>option:</span> <span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span> 
  
    <span class='kw'>when</span> <span class='const'>ExperimentConstants</span><span class='op'>::</span><span class='const'>DAYS_TO_START_FLAG</span>

      <span class='kw'>if</span> <span class='op'>!</span><span class='lparen'>(</span><span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'>Fixnum</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='lparen'>(</span><span class='id identifier rubyid_option'>option</span> <span class='op'>&lt;=</span> <span class='int'>0</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_raise'>raise</span> <span class='const'>ArgumentError</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Days_to_start must be positive integer.</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span> 
      <span class='kw'>end</span>

      <span class='id identifier rubyid_var'>var</span> <span class='op'>=</span> <span class='const'>Variation</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='label'>option:</span> <span class='id identifier rubyid_option'>option</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
    <span class='kw'>end</span> 

    <span class='comment'># set it as part of experiment. 
</span>    <span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_var'>var</span>
  <span class='kw'>end</span>


<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="form_success-instance_method">
  
    - (<tt>Object</tt>) <strong>form_success</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Create an experiment from the params selected on the experiment dashboard.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'experiment/form_success.rb', line 6</span>

<span class='kw'>def</span> <span class='id identifier rubyid_form_success'>form_success</span>
    <span class='comment'># the options selected during experiment
</span>    <span class='comment'># creation. 
</span>    <span class='id identifier rubyid_options_arr'>options_arr</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

    <span class='kw'>case</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:variable</span><span class='rbracket'>]</span>
    <span class='kw'>when</span> <span class='const'>TIME_FLAG</span>
        <span class='comment'>#load selected options. 
</span>        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:time_option_1</span><span class='rbracket'>]</span><span class='comma'>,</span>
                         <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:time_option_2</span><span class='rbracket'>]</span><span class='comma'>,</span>
                         <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:time_option_3</span><span class='rbracket'>]</span><span class='rparen'>)</span>
        <span class='comment'>#clean out nil&#39;s
</span>        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>

        <span class='comment'>#to fit create_experiment format: 
</span>        <span class='comment'>#split &#39;5:30&#39; into [&#39;5&#39;, &#39;30&#39;]  
</span>        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_map!'>map!</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_opt'>opt</span><span class='op'>|</span>
            <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_split'>split</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>:</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
        <span class='kw'>end</span>

        <span class='comment'>#convert to ints
</span>        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_map!'>map!</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_first'>first</span><span class='comma'>,</span> <span class='id identifier rubyid_second'>second</span><span class='op'>|</span>
            <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span> <span class='id identifier rubyid_second'>second</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rparen'>)</span>
        <span class='kw'>end</span>

    <span class='kw'>when</span> <span class='const'>DAYS_TO_START_FLAG</span>
        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:days_option_1</span><span class='rbracket'>]</span><span class='comma'>,</span>
                         <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:days_option_2</span><span class='rbracket'>]</span><span class='comma'>,</span>
                         <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:days_option_3</span><span class='rbracket'>]</span><span class='rparen'>)</span>
        <span class='comment'>#clean out nil&#39;s
</span>        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_delete'>delete</span><span class='lparen'>(</span><span class='kw'>nil</span><span class='rparen'>)</span>
        <span class='comment'>#string-&gt;int [&#39;1&#39;, &#39;2&#39;] -&gt; [1,2]
</span>        <span class='id identifier rubyid_options_arr'>options_arr</span><span class='period'>.</span><span class='id identifier rubyid_map!'>map!</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_opt'>opt</span><span class='op'>|</span> <span class='id identifier rubyid_opt'>opt</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='rbrace'>}</span>
    <span class='kw'>end</span>


    <span class='kw'>begin</span> 
        <span class='comment'># fit create_experiment format: 
</span>        <span class='comment'># convert weeks to days, convert to int.
</span>        <span class='id identifier rubyid_create_experiment'>create_experiment</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:variable</span><span class='rbracket'>]</span><span class='comma'>,</span>
                          <span class='id identifier rubyid_options_arr'>options_arr</span><span class='comma'>,</span>
                          <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:users</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
                          <span class='int'>7</span><span class='op'>*</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:weeks</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_i'>to_i</span><span class='comma'>,</span>
                          <span class='lbracket'>[</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:notes</span><span class='rbracket'>]</span><span class='rbracket'>]</span><span class='rparen'>)</span>


        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Great, the experiment&#39;s set!</span><span class='tstring_end'>&quot;</span></span>
  
    <span class='kw'>rescue</span> <span class='const'>ArgumentError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span> 
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Experiment not created!\n\nArgumentError: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\nBacktrace:\n\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='lparen'>(</span><span class='int'>1</span><span class='op'>..</span><span class='int'>12</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span> <span class='rbrace'>}</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Experiment not created!\n\nArgumentError: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n\n Backtrace </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>rescue</span> <span class='const'>NoMethodError</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_e'>e</span>
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Experiment not created!\n\nNoMethodError: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
        <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span>  <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\nBacktrace:\n\n</span><span class='tstring_end'>&quot;</span></span>
        <span class='lparen'>(</span><span class='int'>1</span><span class='op'>..</span><span class='int'>12</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_print'>print</span> <span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='period'>.</span><span class='id identifier rubyid_shift'>shift</span> <span class='rbrace'>}</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Experiment not created!\n\nNoMethodError: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n\n Backtrace </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_e'>e</span><span class='period'>.</span><span class='id identifier rubyid_backtrace'>backtrace</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
    <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_new_wait-instance_method">
  
    - (<tt>Object</tt>) <strong>get_new_wait</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return the next parent&#39;s wait time</p>

<pre class="code ruby"><code class="ruby">for their first story: one STAGGER
after the last parent&#39;s time.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


69
70
71</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/enroll.rb', line 69</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_new_wait'>get_new_wait</span>
  <span class='ivar'>@wait</span> <span class='op'>+=</span> <span class='const'>STAGGER_TIME</span> 
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="is_dst?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>is_dst?</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return whether it&#39;s daylight savings time in EST TODO fix hack based on
months</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


6
7
8
9
10
11
12</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/set_time.rb', line 6</span>

<span class='kw'>def</span> <span class='id identifier rubyid_is_dst?'>is_dst?</span>
	<span class='kw'>if</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_month'>month</span> <span class='op'>&gt;=</span> <span class='int'>3</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> <span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_month'>month</span> <span class='op'>&lt;</span> <span class='int'>11</span><span class='rparen'>)</span>
		<span class='kw'>return</span> <span class='kw'>true</span>
	<span class='kw'>else</span>
		<span class='kw'>return</span> <span class='kw'>false</span>
	<span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_report-instance_method">
  
    - (<tt>Object</tt>) <strong>send_report</strong>(experiment_id) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Email report about results of the given experiment.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'experiment/report.rb', line 43</span>

<span class='kw'>def</span> <span class='id identifier rubyid_send_report'>send_report</span><span class='lparen'>(</span><span class='id identifier rubyid_experiment_id'>experiment_id</span><span class='rparen'>)</span>

	<span class='id identifier rubyid_exper'>exper</span> <span class='op'>=</span> <span class='const'>Experiment</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_experiment_id'>experiment_id</span><span class='rparen'>)</span>

				<span class='comment'>#capture stdout into the string.
</span>	<span class='id identifier rubyid_email_body'>email_body</span> <span class='op'>=</span> <span class='id identifier rubyid_with_captured_stdout'>with_captured_stdout</span> <span class='lbrace'>{</span>

		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Your experiment has finished! Here&#39;s an overview of the results:\n\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='comment'>#Experiment name
</span>		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Experiment:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variable'>variable</span><span class='rbracket'>]</span>

		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='id identifier rubyid_users'>users</span> <span class='op'>=</span> <span class='int'>0</span>
		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='op'>|</span>
			<span class='id identifier rubyid_users'>users</span> <span class='op'>=</span> <span class='id identifier rubyid_users'>users</span> <span class='op'>+</span> <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Users:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_users'>users</span><span class='rbracket'>]</span>

		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Days:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30f</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='lparen'>(</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span> <span class='op'>-</span> <span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='const'>SEC_IN_DAY</span> <span class='rbracket'>]</span>

		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>



		<span class='comment'>#Label
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
			<span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_i'>i</span> <span class='op'>&lt;</span> <span class='int'>2</span><span class='rparen'>)</span> 
				<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Variation </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span><span class='op'>+</span><span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='kw'>else</span> 
				<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Variation </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_i'>i</span> <span class='op'>+</span> <span class='int'>1</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
			<span class='kw'>end</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='comment'>#Option
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_option'>option</span><span class='rbracket'>]</span>
		<span class='kw'>end</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>
		

		<span class='comment'>#arrays of 0 or 1 --&gt; 0 for quit, 1 for continuing
</span>		<span class='id identifier rubyid_a_scores'>a_scores</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Var 1</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>scores:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rbrace'>}</span>
		<span class='id identifier rubyid_b_scores'>b_scores</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Var 2</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>scores:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rbrace'>}</span>
		<span class='id identifier rubyid_c_scores'>c_scores</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='label'>name:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Var 3</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='label'>scores:</span> <span class='lbracket'>[</span><span class='rbracket'>]</span><span class='rbrace'>}</span>
		<span class='id identifier rubyid_scores'>scores</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='id identifier rubyid_a_scores'>a_scores</span><span class='comma'>,</span> <span class='id identifier rubyid_b_scores'>b_scores</span><span class='comma'>,</span> <span class='id identifier rubyid_c_scores'>c_scores</span><span class='rbracket'>]</span>


		<span class='comment'>#Label
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Continuing:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='comment'>#Continuing
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
			<span class='id identifier rubyid_continuing'>continuing</span> <span class='op'>=</span> <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>subscribed = true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_continuing'>continuing</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='rbracket'>]</span>
			
			<span class='comment'># add a 1 for each continuing, 0 for each dropoff
</span>			<span class='id identifier rubyid_continuing'>continuing</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='period'>.</span><span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span>
				<span class='id identifier rubyid_scores'>scores</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:scores</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='int'>1</span>
			<span class='kw'>end</span>
			<span class='lparen'>(</span><span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>-</span> <span class='id identifier rubyid_continuing'>continuing</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_times'>times</span> <span class='kw'>do</span>
				<span class='id identifier rubyid_scores'>scores</span><span class='lbracket'>[</span><span class='id identifier rubyid_i'>i</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='symbol'>:scores</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='int'>0</span>
			<span class='kw'>end</span>
		<span class='kw'>end</span>


		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='comment'>#Label
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Total:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='comment'>#Total
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30d</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='rbracket'>]</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>


		<span class='id identifier rubyid_percents'>percents</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
		<span class='comment'>#Label
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Percent continuing (%):</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='comment'>#Total
</span>		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_variations'>variations</span><span class='period'>.</span><span class='id identifier rubyid_each_with_index'>each_with_index</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_var'>var</span><span class='comma'>,</span> <span class='id identifier rubyid_i'>i</span><span class='op'>|</span>
			<span class='id identifier rubyid_continuing'>continuing</span> <span class='op'>=</span> <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>subscribed = true</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
			<span class='id identifier rubyid_percent'>percent</span> <span class='op'>=</span> <span class='int'>100</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='id identifier rubyid_continuing'>continuing</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>*</span> <span class='float'>1.0</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='id identifier rubyid_var'>var</span><span class='period'>.</span><span class='id identifier rubyid_users'>users</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30f</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='id identifier rubyid_percent'>percent</span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_percents'>percents</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span> 
				<span class='lbrace'>{</span>
				 <span class='label'>variation:</span> <span class='id identifier rubyid_i'>i</span><span class='op'>+</span><span class='int'>1</span><span class='comma'>,</span> <span class='label'>percent:</span> <span class='id identifier rubyid_percent'>percent</span>
				<span class='rbrace'>}</span>
			<span class='rparen'>)</span>
		<span class='kw'>end</span>

		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='kw'>if</span> <span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_notes'>notes</span> <span class='op'>!=</span> <span class='kw'>nil</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Your inital notes:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_notes'>notes</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>end</span>

		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>


		<span class='id identifier rubyid_combos'>combos</span> <span class='op'>=</span> <span class='id identifier rubyid_scores'>scores</span><span class='period'>.</span><span class='id identifier rubyid_combination'>combination</span><span class='lparen'>(</span><span class='int'>2</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_a'>to_a</span>
		<span class='id identifier rubyid_t_scores'>t_scores</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
		<span class='id identifier rubyid_combos'>combos</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_a'>a</span><span class='comma'>,</span><span class='id identifier rubyid_b'>b</span><span class='op'>|</span>
			<span class='id identifier rubyid_a_name'>a_name</span> <span class='op'>=</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_b_name'>b_name</span> <span class='op'>=</span> <span class='id identifier rubyid_b'>b</span><span class='lbracket'>[</span><span class='symbol'>:name</span><span class='rbracket'>]</span> 

			<span class='id identifier rubyid_a'>a</span> <span class='op'>=</span> <span class='id identifier rubyid_a'>a</span><span class='lbracket'>[</span><span class='symbol'>:scores</span><span class='rbracket'>]</span>
			<span class='id identifier rubyid_b'>b</span> <span class='op'>=</span> <span class='id identifier rubyid_b'>b</span><span class='lbracket'>[</span><span class='symbol'>:scores</span><span class='rbracket'>]</span>
			

			<span class='comment'>#plus 0.01 to SD to avoid division by zero
</span>			<span class='id identifier rubyid_t_scores'>t_scores</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span>

				<span class='lbrace'>{</span> <span class='label'>pair:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_a_name'>a_name</span><span class='embexpr_end'>}</span><span class='tstring_content'> and </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_b_name'>b_name</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>

				  <span class='label'>t_score:</span> <span class='const'>Statsample</span><span class='op'>::</span><span class='const'>Test</span><span class='op'>::</span><span class='const'>T</span><span class='period'>.</span><span class='id identifier rubyid_two_sample_independent'>two_sample_independent</span><span class='lparen'>(</span><span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_mean'>mean</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_mean'>mean</span><span class='comma'>,</span>  
			    <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_standard_deviation'>standard_deviation</span> <span class='op'>+</span> <span class='float'>0.01</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_standard_deviation'>standard_deviation</span> <span class='op'>+</span> <span class='float'>0.01</span><span class='comma'>,</span> <span class='id identifier rubyid_a'>a</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='comma'>,</span> <span class='id identifier rubyid_b'>b</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span><span class='rparen'>)</span>
				<span class='rbrace'>}</span>
			<span class='rparen'>)</span>
		<span class='kw'>end</span>

		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Analysis:\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='comment'>#Label
</span>		<span class='id identifier rubyid_t_scores'>t_scores</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_t'>t</span><span class='lbracket'>[</span><span class='symbol'>:pair</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> T-score:</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='comment'>#T-score
</span>		<span class='id identifier rubyid_t_scores'>t_scores</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_t'>t</span><span class='op'>|</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>%-30s</span><span class='tstring_end'>&quot;</span></span> <span class='op'>%</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_t'>t</span><span class='lbracket'>[</span><span class='symbol'>:t_score</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
		<span class='kw'>end</span>

		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>

		<span class='comment'>#get the highest values of percent continuing
</span>		<span class='id identifier rubyid_current_highest'>current_highest</span> <span class='op'>=</span> <span class='id identifier rubyid_percents'>percents</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
		<span class='id identifier rubyid_percents'>percents</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_percent_hash'>percent_hash</span><span class='op'>|</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_percent_hash'>percent_hash</span><span class='lbracket'>[</span><span class='symbol'>:percent</span><span class='rbracket'>]</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_current_highest'>current_highest</span><span class='lbracket'>[</span><span class='symbol'>:percent</span><span class='rbracket'>]</span>
				<span class='id identifier rubyid_current_highest'>current_highest</span> <span class='op'>=</span> <span class='id identifier rubyid_percent_hash'>percent_hash</span>
			<span class='kw'>end</span>
		<span class='kw'>end</span>

		<span class='id identifier rubyid_highest'>highest</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>
		<span class='comment'>#find multiples 
</span>		<span class='id identifier rubyid_percents'>percents</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_percent_hash'>percent_hash</span><span class='op'>|</span>
			<span class='kw'>if</span> <span class='id identifier rubyid_percent_hash'>percent_hash</span><span class='lbracket'>[</span><span class='symbol'>:percent</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_current_highest'>current_highest</span><span class='lbracket'>[</span><span class='symbol'>:percent</span><span class='rbracket'>]</span>
				<span class='id identifier rubyid_highest'>highest</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span><span class='lparen'>(</span><span class='id identifier rubyid_percent_hash'>percent_hash</span><span class='rparen'>)</span>
			<span class='kw'>end</span>
		<span class='kw'>end</span>

		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Moving forward, it looks like the strongest </span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>if</span> <span class='id identifier rubyid_highest'>highest</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='int'>1</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>variation is: </span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>else</span>
			<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>variations are: </span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_highest'>highest</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_high'>high</span><span class='op'>|</span> <span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Variation </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_high'>high</span><span class='lbracket'>[</span><span class='symbol'>:variation</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>   </span><span class='tstring_end'>&quot;</span></span> <span class='rbrace'>}</span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>if</span> <span class='id identifier rubyid_highest'>highest</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='op'>==</span> <span class='int'>1</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>This </span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>else</span>
			<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>These </span><span class='tstring_end'>&quot;</span></span>
		<span class='kw'>end</span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>had the highest percent of parents continuing: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_current_highest'>current_highest</span><span class='lbracket'>[</span><span class='symbol'>:percent</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>%</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>But-- given the t-score calculated-- this may be due to chance. Refer to the t-table in the link below to see the probability the result is meaningful.</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>
		<span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>t-table: http://www.sjsu.edu/faculty/gerstman/StatPrimer/t-table.pdf</span><span class='tstring_end'>&quot;</span></span>



		<span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span>


		<span class='id identifier rubyid_exper'>exper</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>active:</span> <span class='kw'>false</span><span class='rparen'>)</span>
	<span class='rbrace'>}</span>


	<span class='comment'>#email us the results
</span>	<span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>production</span><span class='tstring_end'>&quot;</span></span>
      <span class='const'>Pony</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='lparen'>(</span><span class='symbol'>:to</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
      		<span class='symbol'>:cc</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>henok.addis@yale.edu</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
            <span class='symbol'>:from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='symbol'>:subject</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StoryTime: Experiment Results.</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='id identifier rubyid_email_body'>email_body</span><span class='comma'>,</span>
            <span class='symbol'>:charset</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>UTF-8</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
	<span class='kw'>else</span>
		<span class='id identifier rubyid_print'>print</span> <span class='id identifier rubyid_email_body'>email_body</span>
	<span class='kw'>end</span>



<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="series_choice_choose-instance_method">
  
    - (<tt>Object</tt>) <strong>series_choice_choose</strong>(user_id, note) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Invite the user to choose a series.</p>

<pre class="code ruby"><code class="ruby">- Update appropriate user attributes to
  indicate waiting on choice.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


45
46
47
48
49
50
51
52
53
54
55
56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/series_choice.rb', line 45</span>

<span class='kw'>def</span> <span class='id identifier rubyid_series_choice_choose'>series_choice_choose</span><span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>

  <span class='comment'># Get set for first in series
</span>  <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_user_id'>user_id</span>
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>next_index_in_series:</span> <span class='int'>0</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>awaiting_choice:</span> <span class='kw'>true</span><span class='rparen'>)</span>

  <span class='comment'># Send invitation to choose.
</span>  <span class='id identifier rubyid_myWait'>myWait</span> <span class='op'>=</span> <span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_getWait'>getWait</span><span class='lparen'>(</span><span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span><span class='rparen'>)</span>
  <span class='const'>NewTextWorker</span><span class='period'>.</span><span class='id identifier rubyid_perform_in'>perform_in</span><span class='lparen'>(</span><span class='id identifier rubyid_myWait'>myWait</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='comma'>,</span>
                           <span class='id identifier rubyid_note'>note</span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_choice'>choice</span><span class='period'>.</span><span class='id identifier rubyid_greet'>greet</span><span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='rbracket'>]</span><span class='comma'>,</span>
                           <span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span><span class='comma'>,</span>
                           <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="series_choice_drop-instance_method">
  
    - (<tt>Object</tt>) <strong>series_choice_drop</strong>(user_id, note) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Drop the user and notify her.</p>

<pre class="code ruby"><code class="ruby">- Update appropriate user attributes to
  indicate drop.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90
91
92
93
94
95
96
97
98
99</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/series_choice.rb', line 87</span>

<span class='kw'>def</span> <span class='id identifier rubyid_series_choice_drop'>series_choice_drop</span><span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>

  <span class='comment'># Get set for first in series
</span>  <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_user_id'>user_id</span>
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>false</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>awaiting_choice:</span> <span class='kw'>false</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_myWait'>myWait</span> <span class='op'>=</span> <span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_getWait'>getWait</span><span class='lparen'>(</span><span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span><span class='rparen'>)</span>
  <span class='const'>NewTextWorker</span><span class='period'>.</span><span class='id identifier rubyid_perform_in'>perform_in</span><span class='lparen'>(</span><span class='id identifier rubyid_myWait'>myWait</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='comma'>,</span>
                           <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_no_reply'>no_reply</span><span class='period'>.</span><span class='id identifier rubyid_dropped'>dropped</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span>
                           <span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span><span class='comma'>,</span>
                           <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="series_choice_remind-instance_method">
  
    - (<tt>Object</tt>) <strong>series_choice_remind</strong>(user_id, note) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Remind the user to choose a series.</p>

<pre class="code ruby"><code class="ruby">- Update appropriate user attributes to
  indicate this.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


68
69
70
71
72
73
74
75
76
77
78
79</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/series_choice.rb', line 68</span>

<span class='kw'>def</span> <span class='id identifier rubyid_series_choice_remind'>series_choice_remind</span><span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span> <span class='id identifier rubyid_user_id'>user_id</span>
  <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_no_reply'>no_reply</span><span class='period'>.</span><span class='id identifier rubyid_day_late'>day_late</span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_choice'>choice</span><span class='period'>.</span><span class='id identifier rubyid_no_greet'>no_greet</span><span class='lbracket'>[</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='rbracket'>]</span>

  <span class='id identifier rubyid_myWait'>myWait</span> <span class='op'>=</span> <span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_getWait'>getWait</span><span class='lparen'>(</span><span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span><span class='rparen'>)</span>
  <span class='const'>NewTextWorker</span><span class='period'>.</span><span class='id identifier rubyid_perform_in'>perform_in</span><span class='lparen'>(</span><span class='id identifier rubyid_myWait'>myWait</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='comma'>,</span>
                           <span class='id identifier rubyid_note'>note</span> <span class='op'>+</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span><span class='comma'>,</span>
                           <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>next_index_in_series:</span> <span class='int'>999</span><span class='rparen'>)</span>  
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="series_choice_reply-instance_method">
  
    - (<tt>Object</tt>) <strong>series_choice_reply</strong>(user_id, params) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Reply to a user&#39;s series choice.</p>

<pre class="code ruby"><code class="ruby">- Set that user&#39;s series. 
- Give that user the first in the series. 
- Reply when given invalid response.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'app/series_choice.rb', line 110</span>

<span class='kw'>def</span> <span class='id identifier rubyid_series_choice_reply'>series_choice_reply</span><span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>

  <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find'>find</span><span class='lparen'>(</span><span class='id identifier rubyid_user_id'>user_id</span><span class='rparen'>)</span>

  <span class='comment'># Get hash of story series.
</span>  <span class='id identifier rubyid_storySeriesHash'>storySeriesHash</span> <span class='op'>=</span> <span class='const'>StorySeries</span><span class='period'>.</span>
                        <span class='id identifier rubyid_getStorySeriesHash'>getStorySeriesHash</span>
  <span class='comment'># Resubscribe, if dropped.
</span>  <span class='kw'>if</span> <span class='op'>!</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_subscribed'>subscribed</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>next_index_in_series:</span> <span class='int'>0</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='comment'># Gave an isolated letter choice.
</span>  <span class='kw'>if</span> <span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(\s|\A|&#39;|&quot;)[a-zA-z](\s|\z|&#39;|&quot;)</span><span class='regexp_end'>/</span></span><span class='period'>.</span><span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
    <span class='comment'># Convert from Match group to first match.
</span>    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='comment'># Grab the letter.
</span>    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[a-zA-z]</span><span class='regexp_end'>/</span></span><span class='period'>.</span><span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_downcase!'>downcase!</span>

  <span class='comment'># Gave the word.
</span>  <span class='comment'># (Its first letter matches a series choice.)
</span>  <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>\A\s*[a-zA-Z]</span><span class='regexp_end'>/</span></span><span class='period'>.</span><span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> 
           <span class='const'>StorySeries</span><span class='period'>.</span><span class='id identifier rubyid_codeIsInHash'>codeIsInHash</span><span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span>
             <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>

    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_body'>body</span><span class='period'>.</span><span class='id identifier rubyid_downcase!'>downcase!</span>

  <span class='comment'># No valid choice: default to first story. 
</span>  <span class='kw'>else</span>
    
    <span class='comment'># Email us, so we avoid this. 
</span>    <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span> <span class='op'>&amp;&amp;</span>
         <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span>

      <span class='const'>Pony</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='lparen'>(</span><span class='symbol'>:to</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='symbol'>:cc</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>henok.addis@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='symbol'>:from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='symbol'>:subject</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StoryTime: an unknown series choice</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
        <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A user texted in an unknown choice
            on series </span><span class='embexpr_beg'>#{</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='embexpr_end'>}</span><span class='tstring_content'>. 

            From: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>
            Body: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> .</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>
    <span class='comment'># Two choices for each series,
</span>    <span class='comment'># so take twice the current series number
</span>    <span class='comment'># to get default.
</span>    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_storySeriesHash'>storySeriesHash</span><span class='period'>.</span><span class='id identifier rubyid_keys'>keys</span><span class='lbracket'>[</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span> <span class='op'>*</span> <span class='int'>2</span><span class='rbracket'>]</span> <span class='comment'>#t0
</span>    <span class='id identifier rubyid_body'>body</span> <span class='op'>=</span> <span class='id identifier rubyid_body'>body</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span> <span class='comment'>#t
</span>  <span class='kw'>end</span>

  <span class='comment'># Push back to zero in case 
</span>  <span class='comment'># changed to 999 to denote one &#39;day&#39; after
</span>  <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>next_index_in_series:</span> <span class='int'>0</span><span class='rparen'>)</span>

  <span class='comment'># A valid choice.
</span>  <span class='kw'>if</span> <span class='const'>StorySeries</span><span class='period'>.</span><span class='id identifier rubyid_codeIsInHash'>codeIsInHash</span><span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span> <span class='op'>+</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rparen'>)</span>
      
    <span class='comment'># Update the series choice.
</span>    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>series_choice:</span> <span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>awaiting_choice:</span> <span class='kw'>false</span><span class='rparen'>)</span>

    <span class='comment'># Grab stories from the series hash. 
</span>    <span class='id identifier rubyid_story'>story</span> <span class='op'>=</span> <span class='id identifier rubyid_storySeriesHash'>storySeriesHash</span><span class='lbracket'>[</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_choice'>series_choice</span> <span class='op'>+</span>
                               <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='rbracket'>]</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span>
    <span class='kw'>if</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_mms'>mms</span> <span class='op'>==</span> <span class='kw'>true</span>
      <span class='comment'># In case of just one photo, this also updates user-info.
</span>      <span class='comment'># Sends last photo in advance
</span>      <span class='const'>NextMessageWorker</span><span class='period'>.</span><span class='id identifier rubyid_perform_in'>perform_in</span><span class='lparen'>(</span><span class='int'>17</span><span class='period'>.</span><span class='id identifier rubyid_seconds'>seconds</span><span class='comma'>,</span> <span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getSMS'>getSMS</span><span class='comma'>,</span>
                <span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getMmsArr'>getMmsArr</span><span class='lbracket'>[</span><span class='int'>1</span><span class='op'>..</span><span class='op'>-</span><span class='int'>1</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
      
       <span class='comment'># Don&#39;t need to send stack 
</span>       <span class='comment'># if a one-pager.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getMmsArr'>getMmsArr</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span> <span class='op'>&gt;</span> <span class='int'>1</span>
        <span class='comment'># Reply with first photo immediately
</span>        <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_mms'>mms</span><span class='lparen'>(</span><span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getMmsArr'>getMmsArr</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
      <span class='kw'>else</span>
        <span class='comment'># If just one photo, reply
</span>        <span class='comment'># with MMS and SMS joint. 
</span>        <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text_and_mms'>text_and_mms</span><span class='lparen'>(</span><span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getSMS'>getSMS</span><span class='comma'>,</span>
          <span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getMmsArr'>getMmsArr</span><span class='lbracket'>[</span><span class='int'>0</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
      <span class='kw'>end</span>

    <span class='kw'>else</span> <span class='comment'># Just SMS.
</span>      <span class='const'>NextMessageWorker</span><span class='period'>.</span><span class='id identifier rubyid_updateUser'>updateUser</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='comma'>,</span>
                                   <span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getPoemSMS'>getPoemSMS</span><span class='rparen'>)</span>
      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getPoemSMS'>getPoemSMS</span><span class='comma'>,</span>
                   <span class='id identifier rubyid_story'>story</span><span class='period'>.</span><span class='id identifier rubyid_getPoemSMS'>getPoemSMS</span><span class='comma'>,</span>
                   <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>    
    <span class='kw'>end</span>
  <span class='comment'># An invalid choice. 
</span>  <span class='kw'>else</span>        
    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_bad_choice'>bad_choice</span><span class='comma'>,</span> 
                 <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_bad_choice'>bad_choice</span><span class='comma'>,</span>
                 <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="with_captured_stdout-instance_method">
  
    - (<tt>Object</tt>) <strong>with_captured_stdout</strong> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>capture stdout and return it as a string/ ensure clause restores $stdout.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


262
263
264
265
266
267
268
269
270
271</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'experiment/report.rb', line 262</span>

<span class='kw'>def</span> <span class='id identifier rubyid_with_captured_stdout'>with_captured_stdout</span>
  <span class='kw'>begin</span>
    <span class='id identifier rubyid_old_stdout'>old_stdout</span> <span class='op'>=</span> <span class='gvar'>$stdout</span>
    <span class='gvar'>$stdout</span> <span class='op'>=</span> <span class='const'>StringIO</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>w</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
    <span class='kw'>yield</span>
    <span class='gvar'>$stdout</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span>
  <span class='kw'>ensure</span>
    <span class='gvar'>$stdout</span> <span class='op'>=</span> <span class='id identifier rubyid_old_stdout'>old_stdout</span>
  <span class='kw'>end</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Thu Jan 14 00:12:08 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.5).
</div>

  </body>
</html>