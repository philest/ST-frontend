<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Class: MainWorker
  
    &mdash; StoryTime Docs
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!MainWorker.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (M)</a> &raquo;
    
    
    <span class="title">MainWorker</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Class: MainWorker
  
  
  
</h1>

<dl class="box">
  
    <dt class="r1">Inherits:</dt>
    <dd class="r1">
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">MainWorker</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
      </dd>
    
  
  
    
  
    
      <dt class="r2">Includes:</dt>
      <dd class="r2">Sidekiq::Worker, Sidetiq::Schedulable</dd>
      
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">workers/main_worker.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Checks who&#39;s set for a story, then calls job to send it. Asynchronous.</p>


  </div>
</div>
<div class="tags">
  

</div>
  <h2>Constant Summary</h2>
  
    <dl class="constants">
      
        <dt id="TESTERS-constant" class="">TESTERS =
          <div class="docstring">
  <div class="discussion">
    
<p>Send to us daily.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span></pre></dd>
      
        <dt id="MODE-constant" class="">MODE =
          <div class="docstring">
  <div class="discussion">
    
<p>Environment.</p>


  </div>
</div>
<div class="tags">
  

</div>
        </dt>
        <dd><pre class="code"><span class='const'>ENV</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>RACK_ENV</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span></pre></dd>
      
    </dl>
  







  
    <h2>
      Class Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#getWait-class_method" title="getWait (class method)">+ (Object) <strong>getWait</strong>(type) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Get and update wait.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#send_story%3F-class_method" title="send_story? (class method)">+ (Boolean) <strong>send_story?</strong>(user_phone, *time) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if the user should receive a story now.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#test_get_wait_times-class_method" title="test_get_wait_times (class method)">+ (Object) <strong>test_get_wait_times</strong> </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#test_push_wait-class_method" title="test_push_wait (class method)">+ (Object) <strong>test_push_wait</strong>(time) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'></div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#valid_time-class_method" title="valid_time (class method)">+ (Object) <strong>valid_time</strong>(user_time, time_now) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if the user&#39;s time in the next or previous 1 minute?.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#valid_weekday%3F-class_method" title="valid_weekday? (class method)">+ (Boolean) <strong>valid_weekday?</strong>(wday_num, days_per_week) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Check if a weekday is valid for a given  schedule of stories per week.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#perform-instance_method" title="#perform (instance method)">- (Object) <strong>perform</strong>(*args) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Sidekiq syntax: Called as &#39;perform_async&#39; to run asynchrnously.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#series_choice_time%3F-instance_method" title="#series_choice_time? (instance method)">- (Boolean) <strong>series_choice_time?</strong>(story_number) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Checks whether it&#39;s time for a series choice.</p>
</div></span>
  
</li>

      
    </ul>
  


  
  

  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="getWait-class_method">
  
    + (<tt>Object</tt>) <strong>getWait</strong>(type) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Get and update wait. For sending Stories AND Texts (choose your story,
notify lateness, etc.) Ensures that no more than one message per second is
sent.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 221</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_getWait'>getWait</span><span class='lparen'>(</span><span class='id identifier rubyid_type'>type</span><span class='rparen'>)</span>

    
    <span class='id identifier rubyid_total_first_msgs'>total_first_msgs</span> <span class='op'>=</span> <span class='cvar'>@@user_num_story</span> <span class='op'>+</span> <span class='cvar'>@@user_num_text</span>

    <span class='id identifier rubyid_wait'>wait</span> <span class='op'>=</span> <span class='id identifier rubyid_total_first_msgs'>total_first_msgs</span> <span class='op'>+</span> <span class='lparen'>(</span><span class='lparen'>(</span><span class='lparen'>(</span><span class='id identifier rubyid_total_first_msgs'>total_first_msgs</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span> <span class='op'>/</span> <span class='const'>TwilioHelper</span><span class='op'>::</span><span class='const'>MMS_WAIT</span><span class='rparen'>)</span> <span class='op'>*</span> <span class='lparen'>(</span><span class='const'>TwilioHelper</span><span class='op'>::</span><span class='const'>MMS_WAIT</span> <span class='op'>*</span> <span class='int'>2</span><span class='rparen'>)</span><span class='rparen'>)</span>

  <span class='comment'>#increments by one each user.
</span>  <span class='comment'>#jumps 40 seconds each 20 users. 
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>STORY</span>
    <span class='cvar'>@@user_num_story</span> <span class='op'>+=</span> <span class='int'>1</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_type'>type</span> <span class='op'>==</span> <span class='const'>NewTextWorker</span><span class='op'>::</span><span class='const'>NOT_STORY</span>
    <span class='cvar'>@@user_num_text</span> <span class='op'>+=</span> <span class='int'>1</span> 
  <span class='kw'>end</span>      

  <span class='kw'>return</span> <span class='id identifier rubyid_wait'>wait</span>

<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="send_story?-class_method">
  
    + (<tt>Boolean</tt>) <strong>send_story?</strong>(user_phone, *time) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if the user should receive a story now.  Time variable allows for
testing, sending time.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 299</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_send_story?'>send_story?</span><span class='lparen'>(</span><span class='id identifier rubyid_user_phone'>user_phone</span><span class='comma'>,</span> <span class='op'>*</span><span class='id identifier rubyid_time'>time</span><span class='rparen'>)</span> 
  <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by'>find_by</span><span class='lparen'>(</span><span class='label'>phone:</span> <span class='id identifier rubyid_user_phone'>user_phone</span><span class='rparen'>)</span>

  <span class='comment'># Allow to manual set time in testing.
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_time'>time</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='op'>==</span> <span class='kw'>false</span> <span class='op'>&amp;&amp;</span>
      <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>TEST</span>

    <span class='cvar'>@@time_now</span> <span class='op'>=</span> <span class='id identifier rubyid_time'>time</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='kw'>end</span>

 <span class='comment'># They&#39;re a candidate if it&#39;s us, or 
</span> <span class='comment'># - it&#39;s the right weekday
</span> <span class='comment'># - they didn&#39;t enroll in the last day.
</span>  <span class='kw'>if</span> <span class='const'>TESTERS</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span> <span class='op'>||</span>
       <span class='lparen'>(</span><span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_valid_weekday?'>valid_weekday?</span><span class='lparen'>(</span><span class='cvar'>@@time_now</span><span class='period'>.</span><span class='id identifier rubyid_wday'>wday</span><span class='comma'>,</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span>
       <span class='lparen'>(</span><span class='cvar'>@@time_now</span> <span class='op'>-</span> <span class='int'>1</span><span class='period'>.</span><span class='id identifier rubyid_day'>day</span><span class='rparen'>)</span> <span class='op'>&gt;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_created_at'>created_at</span><span class='rparen'>)</span>


     <span class='comment'># Is their time in the next or previous 1 minute? 
</span>     <span class='comment'># Use seconds_since_midnight to compare hour:min, not dates.       
</span>     <span class='kw'>if</span> <span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_valid_time'>valid_time</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='comma'>,</span> <span class='cvar'>@@time_now</span><span class='rparen'>)</span> 
          <span class='kw'>return</span> <span class='kw'>true</span>
     <span class='kw'>end</span>

  <span class='kw'>end</span>
  <span class='kw'>return</span> <span class='kw'>false</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="test_get_wait_times-class_method">
  
    + (<tt>Object</tt>) <strong>test_get_wait_times</strong> 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


244
245
246</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 244</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_test_get_wait_times'>test_get_wait_times</span><span class='lparen'>(</span><span class='rparen'>)</span>
  <span class='kw'>return</span> <span class='cvar'>@@times</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="test_push_wait-class_method">
  
    + (<tt>Object</tt>) <strong>test_push_wait</strong>(time) 
  

  

  
</h3><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


240
241
242</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 240</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_test_push_wait'>test_push_wait</span><span class='lparen'>(</span><span class='id identifier rubyid_time'>time</span><span class='rparen'>)</span> 
  <span class='cvar'>@@times</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_time'>time</span> 
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="valid_time-class_method">
  
    + (<tt>Object</tt>) <strong>valid_time</strong>(user_time, time_now) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if the user&#39;s time in the next or previous 1 minute?</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


287
288
289
290
291
292
293
294</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 287</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_valid_time'>valid_time</span><span class='lparen'>(</span><span class='id identifier rubyid_user_time'>user_time</span><span class='comma'>,</span> <span class='id identifier rubyid_time_now'>time_now</span><span class='rparen'>)</span>
  <span class='comment'># Use seconds_since_midnight to compare hour:min, not dates.
</span>
  <span class='lparen'>(</span><span class='id identifier rubyid_user_time'>user_time</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>-</span> <span class='id identifier rubyid_time_now'>time_now</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>&gt;=</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span>
   <span class='id identifier rubyid_user_time'>user_time</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>-</span> <span class='id identifier rubyid_time_now'>time_now</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>&lt;</span> <span class='int'>1</span><span class='period'>.</span><span class='id identifier rubyid_minutes'>minutes</span><span class='rparen'>)</span> <span class='op'>||</span>
  <span class='lparen'>(</span><span class='id identifier rubyid_time_now'>time_now</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>-</span> <span class='id identifier rubyid_user_time'>user_time</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>&gt;=</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span>
   <span class='id identifier rubyid_time_now'>time_now</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>-</span> <span class='id identifier rubyid_user_time'>user_time</span><span class='period'>.</span><span class='id identifier rubyid_seconds_since_midnight'>seconds_since_midnight</span> <span class='op'>&lt;</span> <span class='int'>1</span><span class='period'>.</span><span class='id identifier rubyid_minutes'>minutes</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="valid_weekday?-class_method">
  
    + (<tt>Boolean</tt>) <strong>valid_weekday?</strong>(wday_num, days_per_week) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Check if a weekday is valid for a given  schedule of stories per week.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 267</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_valid_weekday?'>valid_weekday?</span><span class='lparen'>(</span><span class='id identifier rubyid_wday_num'>wday_num</span><span class='comma'>,</span> <span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='rparen'>)</span>
  <span class='comment'># Get valid weekdays
</span>  <span class='kw'>case</span> <span class='id identifier rubyid_days_per_week'>days_per_week</span>
  <span class='kw'>when</span> <span class='int'>3</span>
    <span class='id identifier rubyid_wdays'>wdays</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>1</span><span class='comma'>,</span> <span class='int'>3</span><span class='comma'>,</span> <span class='int'>5</span><span class='rbracket'>]</span>
  <span class='kw'>when</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='int'>2</span>
    <span class='id identifier rubyid_wdays'>wdays</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>2</span><span class='comma'>,</span> <span class='int'>4</span><span class='rbracket'>]</span>
  <span class='kw'>when</span> <span class='int'>1</span>  
    <span class='id identifier rubyid_wdays'>wdays</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='int'>3</span><span class='rbracket'>]</span>
  <span class='kw'>else</span>
    <span class='gvar'>$stderr</span><span class='period'>.</span><span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ERROR: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='embexpr_end'>}</span><span class='tstring_content'> is an invalid days_per_week.</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Is this weekday valid for the given schedule? 
</span>  <span class='kw'>return</span> <span class='id identifier rubyid_wdays'>wdays</span><span class='period'>.</span><span class='id identifier rubyid_include?'>include?</span><span class='lparen'>(</span><span class='id identifier rubyid_wday_num'>wday_num</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="perform-instance_method">
  
    - (<tt>Object</tt>) <strong>perform</strong>(*args) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Sidekiq syntax: Called as &#39;perform_async&#39; to run asynchrnously.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 78</span>

<span class='kw'>def</span> <span class='id identifier rubyid_perform'>perform</span><span class='lparen'>(</span><span class='op'>*</span><span class='id identifier rubyid_args'>args</span><span class='rparen'>)</span>

  <span class='comment'># Send experiment report if ready.
</span>  <span class='id identifier rubyid_check_reports'>check_reports</span>

  <span class='comment'>### TO REFACTOR ##############################
</span>  <span class='cvar'>@@times</span> <span class='op'>=</span> <span class='lbracket'>[</span><span class='rbracket'>]</span>

  <span class='cvar'>@@user_num_story</span> <span class='op'>=</span> <span class='int'>1</span> <span class='comment'>#reset for each call
</span>                 <span class='comment'>#start with the first user.
</span>                 <span class='comment'>#this is used for computing getWait (updated for each STORY)
</span>
  <span class='cvar'>@@user_num_text</span> <span class='op'>=</span> <span class='int'>0</span> <span class='comment'>#this is used for computing getWait (updated for each TEXT)
</span>
    <span class='comment'>#record this before diving into sending each user a message.
</span>    <span class='comment'>#the delay is long and thus it might be 5:33 before some users are checked. 
</span>  <span class='cvar'>@@time_now</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span>
  <span class='comment'>### END TO REFACTOR ###########################
</span>

  <span class='comment'>#Remember all the people who have quit! 
</span>  <span class='id identifier rubyid_quitters'>quitters</span> <span class='op'>=</span> <span class='const'>Array</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span> 


  <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nCurrent Time: </span><span class='embexpr_beg'>#{</span><span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lparen'>(</span><span class='symbol'>:time</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> UTC</span><span class='tstring_end'>&quot;</span></span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nSend story?: \n</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'># Send message to 1) subscribed 2) who are ready for story. 
</span>  <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_where'>where</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>true</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_find_each'>find_each</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_user'>user</span><span class='op'>|</span>

    <span class='comment'>## LEGACY TEST:
</span>    <span class='comment'># Give a Time!
</span>    <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>&amp;&amp;</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>TEST</span>
      <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>time:</span> <span class='const'>DEFAULT_TIME</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span>
      <span class='id identifier rubyid_print'>print</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='embexpr_end'>}</span><span class='tstring_content'>, time </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_time'>time</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='lparen'>(</span><span class='symbol'>:time</span><span class='rparen'>)</span><span class='embexpr_end'>}</span><span class='tstring_content'> </span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>if</span> <span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_send_story?'>send_story?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>YES!!</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>else</span>
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>No.</span><span class='tstring_end'>&#39;</span></span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

      <span class='kw'>if</span> <span class='const'>MainWorker</span><span class='period'>.</span><span class='id identifier rubyid_send_story?'>send_story?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span> 

        <span class='comment'># BREAK
</span>        <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_on_break'>on_break</span>
          <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_days_left_on_break'>days_left_on_break</span> <span class='op'>&gt;</span> <span class='int'>1</span> 
            <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>days_left_on_break:</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_days_left_on_break'>days_left_on_break</span> <span class='op'>-</span> <span class='int'>1</span><span class='rparen'>)</span>
          <span class='kw'>else</span> 
            <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>days_left_on_break:</span> <span class='int'>0</span><span class='rparen'>)</span> <span class='comment'>#remembers that just finished break last time.
</span>            <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>on_break:</span> <span class='kw'>false</span><span class='rparen'>)</span>
          <span class='kw'>end</span>

        <span class='kw'>else</span>

          <span class='comment'>## LEGACY: 
</span>          <span class='comment'># Set default locale.
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span> <span class='op'>==</span> <span class='kw'>nil</span> 
            <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>locale:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>en</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
          <span class='kw'>end</span>
          <span class='comment'># Set this thread&#39;s locale as user&#39;s locale.
</span>          <span class='id identifier rubyid_i18n'>i18n</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_default_places'>default_places</span><span class='rparen'>)</span>
          <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_thread_set'>thread_set</span><span class='lparen'>(</span><span class='id identifier rubyid_i18n'>i18n</span><span class='rparen'>)</span>


          <span class='comment'>#just finished break last time -&gt; include note.
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_days_left_on_break'>days_left_on_break</span> <span class='op'>==</span> <span class='int'>0</span> 
            <span class='id identifier rubyid_note'>note</span> <span class='op'>=</span> <span class='const'>Text</span><span class='op'>::</span><span class='const'>END_BREAK</span> <span class='comment'>#note to append
</span>            <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>days_left_on_break:</span> <span class='kw'>nil</span><span class='rparen'>)</span> <span class='comment'>#set back to normal
</span>          <span class='kw'>else</span>
            <span class='id identifier rubyid_note'>note</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
          <span class='kw'>end</span>


         <span class='comment'>#Should the user be asked to choose a series?
</span>          <span class='comment'># If it&#39;s:
</span>          <span class='comment'># a) not awaiting chioce
</span>          <span class='comment'># b) their third story, or every third one thereafter.
</span>          <span class='comment'># c) they&#39;re not in the middle of a series
</span>          <span class='kw'>if</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_awaiting_choice'>awaiting_choice</span> <span class='op'>==</span> <span class='kw'>false</span> <span class='op'>&amp;&amp;</span>
               <span class='id identifier rubyid_series_choice_time?'>series_choice_time?</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_story_number'>story_number</span><span class='rparen'>)</span> <span class='op'>&amp;&amp;</span> 
               <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_next_index_in_series'>next_index_in_series</span> <span class='op'>==</span> <span class='kw'>nil</span>

               <span class='id identifier rubyid_series_choice_choose'>series_choice_choose</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>

          <span class='comment'># First No response to series choice.
</span>          <span class='comment'># -&gt; Remind them  
</span>          <span class='kw'>elsif</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_awaiting_choice'>awaiting_choice</span> <span class='op'>==</span> <span class='kw'>true</span> <span class='op'>&amp;&amp;</span>
                <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_next_index_in_series'>next_index_in_series</span> <span class='op'>==</span> <span class='int'>0</span> 
               
               <span class='id identifier rubyid_series_choice_remind'>series_choice_remind</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>

          <span class='comment'># Second no response to series choice.
</span>          <span class='comment'># -&gt; Drop and notify them.  
</span>          <span class='kw'>elsif</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_next_index_in_series'>next_index_in_series</span> <span class='op'>==</span> <span class='int'>999</span>
              
               <span class='id identifier rubyid_series_choice_drop'>series_choice_drop</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>
               <span class='id identifier rubyid_quitters'>quitters</span><span class='period'>.</span><span class='id identifier rubyid_push'>push</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span>

          <span class='comment'># send STORY or SERIES, but not if awaiting series response
</span>          <span class='kw'>elsif</span> <span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_series_choice'>series_choice</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>&amp;&amp;</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_next_index_in_series'>next_index_in_series</span> <span class='op'>==</span> <span class='kw'>nil</span><span class='rparen'>)</span> <span class='op'>||</span> <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_series_choice'>series_choice</span> <span class='op'>!=</span> <span class='kw'>nil</span>

               <span class='const'>Story</span><span class='period'>.</span><span class='id identifier rubyid_send_story'>send_story</span><span class='lparen'>(</span><span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='rparen'>)</span>

          <span class='kw'>end</span>

        <span class='kw'>end</span> <span class='comment'>#non-break user
</span>
      <span class='kw'>end</span><span class='comment'>#end send_story? large
</span>

  <span class='kw'>end</span> <span class='comment'>#User.do
</span>
  <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Just checked :-)</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\n</span><span class='tstring_end'>&quot;</span></span> 
  <span class='kw'>end</span>
  
  <span class='comment'>#email us about the quitters
</span>
  <span class='kw'>if</span> <span class='kw'>not</span> <span class='id identifier rubyid_quitters'>quitters</span><span class='period'>.</span><span class='id identifier rubyid_empty?'>empty?</span> <span class='kw'>and</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>production</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>Pony</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='lparen'>(</span><span class='symbol'>:to</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='symbol'>:cc</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>henok.addis@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='symbol'>:from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='symbol'>:subject</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StoryTime: Users were dropped.</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
          <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_quitters'>quitters</span><span class='period'>.</span><span class='id identifier rubyid_length'>length</span><span class='embexpr_end'>}</span><span class='tstring_content'> users never responeded, so were dropped.

                    Here are the bad guys:
                    </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_quitters'>quitters</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
  <span class='kw'>end</span>


<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="series_choice_time?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>series_choice_time?</strong>(story_number) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Checks whether it&#39;s time for a series choice.</p>

<p>Their third story, or every third one thereafter.</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


256
257
258
259
260</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'workers/main_worker.rb', line 256</span>

<span class='kw'>def</span> <span class='id identifier rubyid_series_choice_time?'>series_choice_time?</span><span class='lparen'>(</span><span class='id identifier rubyid_story_number'>story_number</span><span class='rparen'>)</span>
     <span class='id identifier rubyid_story_number'>story_number</span> <span class='op'>==</span> <span class='int'>1</span> <span class='op'>||</span> 
    <span class='lparen'>(</span><span class='id identifier rubyid_story_number'>story_number</span> <span class='op'>!=</span> <span class='int'>0</span> <span class='op'>&amp;&amp;</span> 
     <span class='id identifier rubyid_story_number'>story_number</span> <span class='op'>%</span> <span class='int'>3</span> <span class='op'>==</span> <span class='int'>0</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Thu Jan 14 00:12:08 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.5).
</div>

  </body>
</html>