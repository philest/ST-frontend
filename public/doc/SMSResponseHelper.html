<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>
  Module: SMSResponseHelper
  
    &mdash; StoryTime Docs
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  hasFrames = window.top.frames.main ? true : false;
  relpath = '';
  framesUrl = "frames.html#!SMSResponseHelper.html";
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div id="header">
      <div id="menu">
  
    <a href="_index.html">Index (S)</a> &raquo;
    
    
    <span class="title">SMSResponseHelper</span>
  

  <div class="noframes"><span class="title">(</span><a href="." target="_top">no frames</a><span class="title">)</span></div>
</div>

      <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">
      Class List
    </a>
  
    <a class="full_list_link" id="method_list_link"
        href="method_list.html">
      Method List
    </a>
  
    <a class="full_list_link" id="file_list_link"
        href="file_list.html">
      File List
    </a>
  
</div>
      <div class="clear"></div>
    </div>

    <iframe id="search_frame"></iframe>

    <div id="content"><h1>Module: SMSResponseHelper
  
  
  
</h1>

<dl class="box">
  
  
    
  
    
  
  
  
    <dt class="r1 last">Defined in:</dt>
    <dd class="r1 last">helpers/sms_response_helper.rb</dd>
  
</dl>
<div class="clear"></div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    
<p>Main helper to reply to an SMS. Includes the core  response logic.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Instance Method Summary
      <small>(<a href="#" class="summary_toggle">collapse</a>)</small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#clean_str-instance_method" title="#clean_str (instance method)">- (Object) <strong>clean_str</strong>(str) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return a cleaned string.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#config_reply-instance_method" title="#config_reply (instance method)">- (Object) <strong>config_reply</strong>(params) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Set locale, then reply.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#config_session-instance_method" title="#config_session (instance method)">- (Object) <strong>config_session</strong>(params) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Configure the session to record the last  response and time, reset the new.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#get_day_names-instance_method" title="#get_day_names (instance method)">- (Object) <strong>get_day_names</strong>(days_per_week, carrier) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Schedule depends on days/week:   1: Mon 2: Tues, Thurs 3: Mon, Wed, Fri.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#in_series%3F-instance_method" title="#in_series? (instance method)">- (Boolean) <strong>in_series?</strong>(user_phone) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Was the user in the midst of a series when dropped?.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#repeat%3F-instance_method" title="#repeat? (instance method)">- (Boolean) <strong>repeat?</strong>(body) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Return whether to skip a repeat.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#reply-instance_method" title="#reply (instance method)">- (Object) <strong>reply</strong>(params, locale) </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'>
<p>Reply to an incoming text  (or enroll the user, if appropriate).</p>
</div></span>
  
</li>

      
    </ul>
  



  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="clean_str-instance_method">
  
    - (<tt>Object</tt>) <strong>clean_str</strong>(str) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return a cleaned string.</p>

<pre class="code ruby"><code class="ruby">- Strips trailing, leading whitespace.
- Downcases.
- Removes punctuation.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


157
158
159
160
161
162</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 157</span>

<span class='kw'>def</span> <span class='id identifier rubyid_clean_str'>clean_str</span><span class='lparen'>(</span><span class='id identifier rubyid_str'>str</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_str'>str</span> <span class='op'>=</span> <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
  <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_downcase!'>downcase!</span>
  <span class='id identifier rubyid_str'>str</span><span class='period'>.</span><span class='id identifier rubyid_gsub!'>gsub!</span><span class='lparen'>(</span><span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>[\.\,\!\?\&#39;]</span><span class='regexp_end'>/</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span>
  <span class='id identifier rubyid_str'>str</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="config_reply-instance_method">
  
    - (<tt>Object</tt>) <strong>config_reply</strong>(params) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Set locale, then reply.</p>

<pre class="code ruby"><code class="ruby">- defaults to English</code></pre>
<dl class="rdoc-list label-list"><dt>parmams
<dd>
<p>fake user data</p>
</dd></dl>

<pre class="code ruby"><code class="ruby">- {Carrier: &quot;ATT&quot;, Body: &quot;STORY&quot;} etc.
- Mocked in testing; normally given by Twilio</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


135
136
137
138
139
140
141
142
143
144
145
146
147
148
149</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 135</span>

<span class='kw'>def</span> <span class='id identifier rubyid_config_reply'>config_reply</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>  
  <span class='comment'>#1. Set locale. 
</span>  <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_phone'>find_by_phone</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span>
  
  <span class='kw'>if</span> <span class='ivar'>@user</span>
    <span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span>
  <span class='kw'>elsif</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:locale</span><span class='rbracket'>]</span>
    <span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:locale</span><span class='rbracket'>]</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_locale'>locale</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>en</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='comment'>#2. Reply. 
</span>  <span class='id identifier rubyid_reply'>reply</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='rparen'>)</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="config_session-instance_method">
  
    - (<tt>Object</tt>) <strong>config_session</strong>(params) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Configure the session to record the last  response and time, reset the new.</p>
<dl class="rdoc-list label-list"><dt>params
<dd>
<p>user data</p>
</dd></dl>

<pre class="code ruby"><code class="ruby">- {Carrier: &quot;ATT&quot;, Body: &quot;STORY&quot;} etc.</code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


48
49
50
51
52
53
54
55
56
57
58</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 48</span>

<span class='kw'>def</span> <span class='id identifier rubyid_config_session'>config_session</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>
<span class='comment'>## Remeber last response and time ##
</span><span class='comment'>#new becomes old
</span>  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> 
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_time</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new_time</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>now_for_us</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>next_for_us</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='comment'>#reset the new
</span>  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_strip'>strip</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>new_time</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span>
  <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>next_for_us</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>false</span> <span class='comment'>#default: don&#39;t send us their response.
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="get_day_names-instance_method">
  
    - (<tt>Object</tt>) <strong>get_day_names</strong>(days_per_week, carrier) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Schedule depends on days/week:</p>

<p>1: Mon 2: Tues, Thurs 3: Mon, Wed, Fri</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 96</span>

<span class='kw'>def</span> <span class='id identifier rubyid_get_day_names'>get_day_names</span><span class='lparen'>(</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='comma'>,</span> <span class='id identifier rubyid_carrier'>carrier</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_end'>&#39;</span></span>
 
  <span class='kw'>case</span> <span class='id identifier rubyid_days_per_week'>days_per_week</span>
  <span class='kw'>when</span> <span class='int'>1</span>
      <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_wed'>wed</span>
  <span class='kw'>when</span> <span class='int'>2</span><span class='comma'>,</span> <span class='kw'>nil</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_carrier'>carrier</span> <span class='op'>==</span> <span class='const'>SPRINT</span>
      <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span>  <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_sprint'>sprint</span><span class='period'>.</span><span class='id identifier rubyid_tue'>tue</span> <span class='op'>+</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_sprint'>sprint</span><span class='period'>.</span><span class='id identifier rubyid_th'>th</span>
    <span class='kw'>else</span>       
      <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='period'>.</span><span class='id identifier rubyid_tue'>tue</span> <span class='op'>+</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='period'>.</span><span class='id identifier rubyid_th'>th</span>
    <span class='kw'>end</span>
  <span class='kw'>when</span> <span class='int'>3</span>
    <span class='kw'>if</span> <span class='id identifier rubyid_carrier'>carrier</span> <span class='op'>==</span> <span class='const'>SPRINT</span>
      <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_letters'>letters</span><span class='period'>.</span><span class='const'>M</span> <span class='op'>+</span> 
         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_letters'>letters</span><span class='period'>.</span><span class='const'>W</span> <span class='op'>+</span> 
         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>-</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_letters'>letters</span><span class='period'>.</span><span class='const'>F</span>
    <span class='kw'>else</span>       
      <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_mon'>mon</span> <span class='op'>+</span> 
         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_wed'>wed</span> <span class='op'>+</span>
         <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>/</span><span class='tstring_end'>&quot;</span></span> <span class='op'>+</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_weekday'>weekday</span><span class='period'>.</span><span class='id identifier rubyid_fri'>fri</span>
    <span class='kw'>end</span>
  <span class='kw'>else</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ERR: invalid days of week</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_day_names'>day_names</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="in_series?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>in_series?</strong>(user_phone) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Was the user in the midst of a series when dropped?</p>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


64
65
66
67
68
69</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 64</span>

<span class='kw'>def</span> <span class='id identifier rubyid_in_series?'>in_series?</span><span class='lparen'>(</span><span class='id identifier rubyid_user_phone'>user_phone</span><span class='rparen'>)</span>
  <span class='id identifier rubyid_user'>user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_phone'>find_by_phone</span> <span class='id identifier rubyid_user_phone'>user_phone</span>
  
  <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_next_index_in_series'>next_index_in_series</span> <span class='op'>==</span> <span class='int'>999</span> <span class='op'>||</span> 
    <span class='id identifier rubyid_user'>user</span><span class='period'>.</span><span class='id identifier rubyid_awaiting_choice'>awaiting_choice</span> <span class='op'>==</span> <span class='kw'>true</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="repeat?-instance_method">
  
    - (<tt>Boolean</tt>) <strong>repeat?</strong>(body) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Return whether to skip a repeat. Repeat when:</p>

<pre class="code ruby"><code class="ruby">- 1) the same response had been sent 
- 2) in the previous 55 seconds</code></pre>


  </div>
</div>
<div class="tags">
  
<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Boolean</tt>)</span>
      
      
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


76
77
78
79
80
81
82
83
84
85
86
87
88</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 76</span>

<span class='kw'>def</span> <span class='id identifier rubyid_repeat?'>repeat?</span><span class='lparen'>(</span><span class='id identifier rubyid_body'>body</span><span class='rparen'>)</span>
  <span class='kw'>if</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>&amp;&amp;</span>
       <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>==</span> <span class='id identifier rubyid_body'>body</span> <span class='op'>&amp;&amp;</span>
       <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_time</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>-</span> <span class='int'>55</span> <span class='op'>&lt;</span> <span class='const'>Time</span><span class='period'>.</span><span class='id identifier rubyid_now'>now</span><span class='period'>.</span><span class='id identifier rubyid_utc'>utc</span>

    <span class='id identifier rubyid_repeat'>repeat</span> <span class='op'>=</span> <span class='kw'>true</span>
  <span class='kw'>else</span> 
    <span class='id identifier rubyid_repeat'>repeat</span> <span class='op'>=</span> <span class='kw'>false</span> 
  <span class='kw'>end</span>
<span class='comment'>##
</span><span class='comment'># Return String of story weekdays for reply,
</span><span class='comment'># with abbreviations for Sprint.
</span><span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
      <div class="method_details ">
  <h3 class="signature " id="reply-instance_method">
  
    - (<tt>Object</tt>) <strong>reply</strong>(params, locale) 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    
<p>Reply to an incoming text  (or enroll the user, if appropriate)</p>
<dl class="rdoc-list label-list"><dt>params
<dd>
<p>user data</p>
</dd></dl>

<pre class="code ruby"><code class="ruby">- {Carrier: &quot;ATT&quot;, Body: &quot;STORY&quot;} etc.</code></pre>
<dl class="rdoc-list label-list"><dt>locale
<dd>
<p>the user&#39;s locale</p>
</dd></dl>

<pre class="code ruby"><code class="ruby"><span class='op'>-</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>en</span><span class='tstring_end'>&quot;</span></span></code></pre>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'helpers/sms_response_helper.rb', line 172</span>

<span class='kw'>def</span> <span class='id identifier rubyid_reply'>reply</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='rparen'>)</span>

  <span class='comment'># Standardize the incoming SMS.
</span>  <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_clean_str'>clean_str</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='id identifier rubyid_config_session'>config_session</span> <span class='id identifier rubyid_params'>params</span>
  <span class='comment'># Get the user.
</span>  <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>User</span><span class='period'>.</span><span class='id identifier rubyid_find_by_phone'>find_by_phone</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='rparen'>)</span>

  <span class='comment'># Set this thread&#39;s locale.  
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_locale'>locale</span> <span class='op'>!=</span> <span class='kw'>nil</span> <span class='op'>&amp;&amp;</span> 
       <span class='ivar'>@user</span> <span class='op'>!=</span> <span class='kw'>nil</span>

    <span class='id identifier rubyid_i18n'>i18n</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='op'>::</span><span class='const'>I18n</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='op'>::</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_default_places'>default_places</span><span class='rparen'>)</span>
    <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_thread_set'>thread_set</span><span class='lparen'>(</span><span class='id identifier rubyid_i18n'>i18n</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='kw'>case</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span>

  <span class='comment'># STORY
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_story'>story</span>
    <span class='comment'># Enroll new user. 
</span>    <span class='kw'>if</span> <span class='ivar'>@user</span> <span class='op'>==</span> <span class='kw'>nil</span> <span class='op'>||</span>
         <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span> <span class='op'>==</span> <span class='kw'>true</span>

      <span class='id identifier rubyid_app_enroll'>app_enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='const'>STORY</span><span class='rparen'>)</span>
    <span class='comment'># Autodropped from series, now re-subscribing.
</span>    <span class='kw'>elsif</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_subscribed'>subscribed</span> <span class='op'>==</span> <span class='kw'>false</span> <span class='op'>&amp;&amp;</span> 
            <span class='id identifier rubyid_in_series?'>in_series?</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

      <span class='comment'># Resubscribe. 
</span>      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_msg'>msg</span> <span class='op'>=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span><span class='period'>.</span><span class='id identifier rubyid_resubscribe'>resubscribe</span><span class='period'>.</span><span class='id identifier rubyid_short'>short</span> <span class='op'>+</span>
            <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_choice'>choice</span><span class='period'>.</span><span class='id identifier rubyid_no_greet'>no_greet</span><span class='lbracket'>[</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_series_number'>series_number</span><span class='rbracket'>]</span>
            <span class='comment'>#longer message, give more newlines
</span>      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>next_index_in_series:</span> <span class='int'>0</span><span class='rparen'>)</span>
      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>awaiting_choice:</span> <span class='kw'>true</span><span class='rparen'>)</span>

      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='id identifier rubyid_msg'>msg</span><span class='comma'>,</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

    <span class='comment'># Dropped manually, out of series
</span>    <span class='kw'>elsif</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_subscribed'>subscribed</span> <span class='op'>==</span> <span class='kw'>false</span> 
      <span class='comment'># Resubscribe. 
</span>      <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>true</span><span class='rparen'>)</span>
      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span><span class='period'>.</span><span class='id identifier rubyid_resubscribe'>resubscribe</span><span class='period'>.</span><span class='id identifier rubyid_long'>long</span><span class='comma'>,</span> 
                   <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span><span class='period'>.</span><span class='id identifier rubyid_resubscribe'>resubscribe</span><span class='period'>.</span><span class='id identifier rubyid_long'>long</span><span class='comma'>,</span>
                   <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
    <span class='kw'>end</span>

  <span class='comment'># SAMPLE or EXAMPLE
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span><span class='comma'>,</span>
       <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_example'>example</span>

    <span class='id identifier rubyid_app_enroll'>app_enroll</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='comma'>,</span> <span class='id identifier rubyid_locale'>locale</span><span class='comma'>,</span> <span class='const'>SAMPLE</span><span class='rparen'>)</span>

  <span class='comment'># HELP
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_help'>help</span>
    <span class='comment'># Get string of weekdays for reply.
</span>    <span class='id identifier rubyid_day_names'>day_names</span> <span class='op'>=</span> <span class='id identifier rubyid_get_day_names'>get_day_names</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='comma'>,</span>
                             <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_carrier'>carrier</span><span class='rparen'>)</span>
    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_help'>help</span><span class='period'>.</span><span class='id identifier rubyid_normal'>normal</span><span class='lparen'>(</span><span class='id identifier rubyid_day_names'>day_names</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span>
                 <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_help'>help</span><span class='period'>.</span><span class='id identifier rubyid_sprint'>sprint</span><span class='lparen'>(</span><span class='id identifier rubyid_day_names'>day_names</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_str'>to_str</span><span class='comma'>,</span>
                 <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

  <span class='comment'># BREAK
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_break'>break</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>on_break:</span> <span class='kw'>true</span><span class='rparen'>)</span>
    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>days_left_on_break:</span> <span class='const'>Text</span><span class='op'>::</span><span class='const'>BREAK_LENGTH</span><span class='rparen'>)</span>

    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_break'>break</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='comma'>,</span>
                 <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_break'>break</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span><span class='comma'>,</span>
                 <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

  <span class='comment'># STOP
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_stop'>stop</span><span class='comma'>,</span>
       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>stop now</span><span class='tstring_end'>&quot;</span></span>

    <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span>
    <span class='comment'># TODO Add to list in Redis. 
</span>    <span class='comment'># Report quitters to us by email.
</span>      <span class='const'>Pony</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='lparen'>(</span><span class='symbol'>:to</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='symbol'>:cc</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>henok.addis@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='symbol'>:from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='symbol'>:subject</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StoryTime: A user quit.</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
            <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A user texted STOP. 

                From: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>
                Body: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>
                Message #: </span><span class='embexpr_beg'>#{</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_total_messages'>total_messages</span><span class='embexpr_end'>}</span><span class='tstring_content'>
                
                Body of prev text: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>
                Time of prev text: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_time</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
    <span class='kw'>end</span>

    <span class='comment'>#change subscription, then text us. 
</span>    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>subscribed:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_note'>note</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>+</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>quit StoryTime.</span><span class='tstring_end'>&quot;</span></span>
    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_new_text'>new_text</span><span class='lparen'>(</span><span class='id identifier rubyid_note'>note</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>

  <span class='comment'># TEXT
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='comment'>#change mms to sms
</span>    <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_update'>update</span><span class='lparen'>(</span><span class='label'>mms:</span> <span class='kw'>false</span><span class='rparen'>)</span>
    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_mms_update'>mms_update</span><span class='comma'>,</span>
                 <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_mms_update'>mms_update</span><span class='comma'>,</span>
                 <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

  <span class='comment'># THANKS or THANK YOU 
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_sms'>sms</span><span class='period'>.</span><span class='id identifier rubyid_thanks'>thanks</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
       <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_sms'>sms</span><span class='period'>.</span><span class='id identifier rubyid_thank_you'>thank_you</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span><span class='id identifier rubyid_sure'>sure</span><span class='comma'>,</span>
                 <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span><span class='id identifier rubyid_sure'>sure</span><span class='comma'>,</span>
                 <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

  <span class='comment'># WHO IS THIS or WHO&#39;S THIS
</span>  <span class='kw'>when</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_sms'>sms</span><span class='period'>.</span><span class='id identifier rubyid_whos_this'>whos_this</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
       <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_sms'>sms</span><span class='period'>.</span><span class='id identifier rubyid_who_is_this'>who_is_this</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>

    <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span>
                    <span class='id identifier rubyid_who_we_are'>who_we_are</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
                 <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_misc'>misc</span><span class='period'>.</span><span class='id identifier rubyid_reply'>reply</span><span class='period'>.</span>
                    <span class='id identifier rubyid_who_we_are'>who_we_are</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_days_per_week'>days_per_week</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
                 <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

  <span class='kw'>else</span>  

    <span class='comment'>### NOT STANDARD RESPONSE ### 
</span>
    <span class='comment'># Someone replied to the SAMPLE text.
</span>    <span class='kw'>if</span> <span class='ivar'>@user</span> <span class='op'>&amp;&amp;</span>
         <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span> <span class='op'>&amp;&amp;</span>
         <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_commands'>commands</span><span class='period'>.</span><span class='id identifier rubyid_story'>story</span>
      
      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span><span class='period'>.</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span>
                   <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_sample'>sample</span><span class='period'>.</span><span class='id identifier rubyid_post'>post</span><span class='comma'>,</span>
                   <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>

    <span class='comment'># Unregistered user.
</span>    <span class='kw'>elsif</span> <span class='ivar'>@user</span> <span class='op'>==</span> <span class='kw'>nil</span>
      <span class='comment'># Email us about problem.
</span>      <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span> <span class='op'>&amp;&amp;</span>
          <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span>

        <span class='const'>Pony</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='lparen'>(</span><span class='symbol'>:to</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
                  <span class='symbol'>:cc</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>henok.addis@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
                  <span class='symbol'>:from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
                  <span class='symbol'>:subject</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StoryTime: an unknown </span><span class='tstring_end'>&#39;</span></span>\
                              <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SMS (non-user)</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
                  <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>An unregistered user texted </span><span class='tstring_end'>&#39;</span></span>\
                           <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>in an unknown response.</span><span class='tstring_end'>&#39;</span></span>\
                           <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\nFrom: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'>\n</span><span class='tstring_end'>&quot;</span></span>\
                           <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Body: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> .</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>

      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_no_signup_match'>no_signup_match</span><span class='comma'>,</span> 
                   <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_no_signup_match'>no_signup_match</span><span class='comma'>,</span>
                   <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='rparen'>)</span>

    <span class='comment'># Send the message to us. 
</span>    <span class='kw'>elsif</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>now_for_us</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_new_text'>new_text</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='embexpr_end'>}</span><span class='tstring_content'> sent: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='embexpr_beg'>#{</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='embexpr_end'>}</span><span class='tstring_content'> sent: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                       <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_us'>to_us</span><span class='period'>.</span><span class='id identifier rubyid_thanks'>thanks</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> 
                   <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_to_us'>to_us</span><span class='period'>.</span><span class='id identifier rubyid_thanks'>thanks</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
                   <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
     
    <span class='comment'># A Series Choice.  
</span>    <span class='kw'>elsif</span> <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_awaiting_choice'>awaiting_choice</span> <span class='op'>||</span>
            <span class='lparen'>(</span><span class='op'>!</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_subscribed'>subscribed</span> <span class='op'>&amp;&amp;</span>
             <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>(\s|\A|&#39;|&quot;)[a-zA-z](\s|\z|&#39;|&quot;)</span><span class='regexp_end'>/</span></span><span class='period'>.</span>
             <span class='id identifier rubyid_match'>match</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='rparen'>)</span><span class='rparen'>)</span>
           <span class='comment'># 2nd condition: A dropped user&#39;s choice. 
</span>
      <span class='id identifier rubyid_series_choice_reply'>series_choice_reply</span><span class='lparen'>(</span><span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>

    <span class='comment'>## Response Not Recognized  
</span>    <span class='kw'>else</span> 

      <span class='comment'>## Report this to us by email (and SMS)
</span>      <span class='kw'>if</span> <span class='const'>MODE</span> <span class='op'>==</span> <span class='const'>PRO</span> <span class='op'>&amp;&amp;</span>
           <span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span> <span class='op'>!=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span>

        <span class='const'>Pony</span><span class='period'>.</span><span class='id identifier rubyid_mail'>mail</span><span class='lparen'>(</span><span class='symbol'>:to</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
              <span class='symbol'>:cc</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>henok.addis@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
              <span class='symbol'>:from</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>phil.esterman@yale.edu</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
              <span class='symbol'>:subject</span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>StoryTime: an unknown SMS (user)</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span>
              <span class='symbol'>:body</span> <span class='op'>=&gt;</span> <span class='lparen'>(</span><span class='id identifier rubyid_note'>note</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>A registered user texted in</span><span class='tstring_end'>&quot;</span></span>\
                               <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> an unknown response.</span><span class='tstring_end'>&quot;</span></span>\
                               <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\n\nFrom: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:From</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>\
                               <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>\nBody: </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_content'> .</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span><span class='rparen'>)</span>
        <span class='comment'># Send us text, too.
</span>        <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_new_text'>new_text</span><span class='lparen'>(</span><span class='id identifier rubyid_note'>note</span><span class='comma'>,</span> <span class='id identifier rubyid_note'>note</span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>+15612125831</span><span class='tstring_end'>&quot;</span></span><span class='rparen'>)</span>
      <span class='kw'>end</span>

         <span class='comment'># Skip a repeated text.
</span>      <span class='kw'>if</span> <span class='id identifier rubyid_repeat?'>repeat?</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='lbracket'>[</span><span class='symbol'>:Body</span><span class='rbracket'>]</span><span class='rparen'>)</span> 
        <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>DONT send this repeat: message</span><span class='tstring_end'>&quot;</span></span>\
             <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> </span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>prev_body</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>\
             <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'> was sent already</span><span class='tstring_end'>&quot;</span></span>
      <span class='kw'>else</span>
        <span class='comment'># Forward their next text to us. 
</span>        <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>next_for_us</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='kw'>true</span> 

        <span class='const'>TwilioHelper</span><span class='period'>.</span><span class='id identifier rubyid_text'>text</span><span class='lparen'>(</span><span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_no_option'>no_option</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span> 
                     <span class='const'>R18n</span><span class='period'>.</span><span class='id identifier rubyid_t'>t</span><span class='period'>.</span><span class='id identifier rubyid_error'>error</span><span class='period'>.</span><span class='id identifier rubyid_no_option_sprint'>no_option_sprint</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span><span class='comma'>,</span>
                     <span class='ivar'>@user</span><span class='period'>.</span><span class='id identifier rubyid_phone'>phone</span><span class='rparen'>)</span>
      <span class='kw'>end</span> 

    <span class='kw'>end</span> <span class='comment'># list of abnormal responses 
</span>       
  <span class='kw'>end</span> <span class='comment'># case-statement
</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

    <div id="footer">
  Generated on Thu Jan 14 00:12:08 2016 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.8.7.6 (ruby-2.1.5).
</div>

  </body>
</html>